package main

import (
	"encoding/json"
	"os"
	"runtime/pprof"
	"testing"

	"github.com/newrelic/go-agent/v3/newrelic"
	fastGame "github.com/nosnaws/tiam/game"
)

func TestSnakePerformance(t *testing.T) {
	t.Skip()

	//cpufile, err := os.Create("cpu.pprof")
	//if err != nil {
	//panic(err)
	//}
	//err = pprof.StartCPUProfile(cpufile)
	//if err != nil {
	//panic(err)
	//}
	//defer cpufile.Close()
	//defer pprof.StopCPUProfile()

	gameStr := []byte("{\"game\":{\"id\":\"1f51a054-824d-40f4-9d33-58148f7e65ea\",\"ruleset\":{\"name\":\"wrapped\",\"version\":\"cli\",\"settings\":{\"foodSpawnChance\":15,\"minimumFood\":1,\"hazardDamagePerTurn\":100,\"hazardMap\":\"\",\"hazardMapAuthor\":\"\",\"royale\":{\"shrinkEveryNTurns\":25},\"squad\":{\"allowBodyCollisions\":false,\"sharedElimination\":false,\"sharedHealth\":false,\"sharedLength\":false}}},\"map\":\"arcade_maze\",\"timeout\":500,\"source\":\"\"},\"turn\":0,\"board\":{\"height\":21,\"width\":19,\"snakes\":[{\"id\":\"3ae64ecc-e894-4493-86c8-3a5593376388\",\"name\":\"tiam\",\"latency\":\"0\",\"health\":100,\"body\":[{\"x\":14,\"y\":7},{\"x\":14,\"y\":7},{\"x\":14,\"y\":7}],\"head\":{\"x\":14,\"y\":7},\"length\":3,\"shout\":\"\",\"squad\":\"\",\"customizations\":{\"color\":\"#002080\",\"head\":\"evil\",\"tail\":\"fat-rattle\"}},{\"id\":\"7ce0ba30-4734-4216-9be8-a421a73b40a6\",\"name\":\"local\",\"latency\":\"0\",\"health\":100,\"body\":[{\"x\":4,\"y\":7},{\"x\":4,\"y\":7},{\"x\":4,\"y\":7}],\"head\":{\"x\":4,\"y\":7},\"length\":3,\"shout\":\"\",\"squad\":\"\",\"customizations\":{\"color\":\"#002080\",\"head\":\"evil\",\"tail\":\"fat-rattle\"}}],\"food\":[{\"x\":9,\"y\":11}],\"hazards\":[{\"x\":0,\"y\":20},{\"x\":2,\"y\":20},{\"x\":3,\"y\":20},{\"x\":4,\"y\":20},{\"x\":5,\"y\":20},{\"x\":6,\"y\":20},{\"x\":7,\"y\":20},{\"x\":8,\"y\":20},{\"x\":9,\"y\":20},{\"x\":10,\"y\":20},{\"x\":11,\"y\":20},{\"x\":12,\"y\":20},{\"x\":13,\"y\":20},{\"x\":14,\"y\":20},{\"x\":15,\"y\":20},{\"x\":16,\"y\":20},{\"x\":18,\"y\":20},{\"x\":0,\"y\":19},{\"x\":9,\"y\":19},{\"x\":18,\"y\":19},{\"x\":0,\"y\":18},{\"x\":2,\"y\":18},{\"x\":3,\"y\":18},{\"x\":5,\"y\":18},{\"x\":6,\"y\":18},{\"x\":7,\"y\":18},{\"x\":9,\"y\":18},{\"x\":11,\"y\":18},{\"x\":12,\"y\":18},{\"x\":13,\"y\":18},{\"x\":15,\"y\":18},{\"x\":16,\"y\":18},{\"x\":18,\"y\":18},{\"x\":0,\"y\":17},{\"x\":18,\"y\":17},{\"x\":0,\"y\":16},{\"x\":2,\"y\":16},{\"x\":3,\"y\":16},{\"x\":5,\"y\":16},{\"x\":7,\"y\":16},{\"x\":8,\"y\":16},{\"x\":9,\"y\":16},{\"x\":10,\"y\":16},{\"x\":11,\"y\":16},{\"x\":13,\"y\":16},{\"x\":15,\"y\":16},{\"x\":16,\"y\":16},{\"x\":18,\"y\":16},{\"x\":0,\"y\":15},{\"x\":5,\"y\":15},{\"x\":9,\"y\":15},{\"x\":13,\"y\":15},{\"x\":18,\"y\":15},{\"x\":0,\"y\":14},{\"x\":3,\"y\":14},{\"x\":5,\"y\":14},{\"x\":6,\"y\":14},{\"x\":7,\"y\":14},{\"x\":9,\"y\":14},{\"x\":11,\"y\":14},{\"x\":12,\"y\":14},{\"x\":13,\"y\":14},{\"x\":15,\"y\":14},{\"x\":18,\"y\":14},{\"x\":0,\"y\":13},{\"x\":3,\"y\":13},{\"x\":5,\"y\":13},{\"x\":13,\"y\":13},{\"x\":15,\"y\":13},{\"x\":18,\"y\":13},{\"x\":0,\"y\":12},{\"x\":1,\"y\":12},{\"x\":2,\"y\":12},{\"x\":3,\"y\":12},{\"x\":5,\"y\":12},{\"x\":7,\"y\":12},{\"x\":9,\"y\":12},{\"x\":11,\"y\":12},{\"x\":13,\"y\":12},{\"x\":15,\"y\":12},{\"x\":16,\"y\":12},{\"x\":17,\"y\":12},{\"x\":18,\"y\":12},{\"x\":7,\"y\":11},{\"x\":11,\"y\":11},{\"x\":0,\"y\":10},{\"x\":1,\"y\":10},{\"x\":2,\"y\":10},{\"x\":3,\"y\":10},{\"x\":5,\"y\":10},{\"x\":7,\"y\":10},{\"x\":9,\"y\":10},{\"x\":11,\"y\":10},{\"x\":13,\"y\":10},{\"x\":15,\"y\":10},{\"x\":16,\"y\":10},{\"x\":17,\"y\":10},{\"x\":18,\"y\":10},{\"x\":0,\"y\":9},{\"x\":3,\"y\":9},{\"x\":5,\"y\":9},{\"x\":13,\"y\":9},{\"x\":15,\"y\":9},{\"x\":18,\"y\":9},{\"x\":0,\"y\":8},{\"x\":3,\"y\":8},{\"x\":5,\"y\":8},{\"x\":7,\"y\":8},{\"x\":8,\"y\":8},{\"x\":9,\"y\":8},{\"x\":10,\"y\":8},{\"x\":11,\"y\":8},{\"x\":13,\"y\":8},{\"x\":15,\"y\":8},{\"x\":18,\"y\":8},{\"x\":0,\"y\":7},{\"x\":9,\"y\":7},{\"x\":18,\"y\":7},{\"x\":0,\"y\":6},{\"x\":2,\"y\":6},{\"x\":3,\"y\":6},{\"x\":5,\"y\":6},{\"x\":6,\"y\":6},{\"x\":7,\"y\":6},{\"x\":9,\"y\":6},{\"x\":11,\"y\":6},{\"x\":12,\"y\":6},{\"x\":13,\"y\":6},{\"x\":15,\"y\":6},{\"x\":16,\"y\":6},{\"x\":18,\"y\":6},{\"x\":0,\"y\":5},{\"x\":3,\"y\":5},{\"x\":15,\"y\":5},{\"x\":18,\"y\":5},{\"x\":0,\"y\":4},{\"x\":1,\"y\":4},{\"x\":3,\"y\":4},{\"x\":5,\"y\":4},{\"x\":7,\"y\":4},{\"x\":8,\"y\":4},{\"x\":9,\"y\":4},{\"x\":10,\"y\":4},{\"x\":11,\"y\":4},{\"x\":13,\"y\":4},{\"x\":15,\"y\":4},{\"x\":17,\"y\":4},{\"x\":18,\"y\":4},{\"x\":0,\"y\":3},{\"x\":5,\"y\":3},{\"x\":9,\"y\":3},{\"x\":13,\"y\":3},{\"x\":18,\"y\":3},{\"x\":0,\"y\":2},{\"x\":2,\"y\":2},{\"x\":3,\"y\":2},{\"x\":4,\"y\":2},{\"x\":5,\"y\":2},{\"x\":6,\"y\":2},{\"x\":7,\"y\":2},{\"x\":9,\"y\":2},{\"x\":11,\"y\":2},{\"x\":12,\"y\":2},{\"x\":13,\"y\":2},{\"x\":14,\"y\":2},{\"x\":15,\"y\":2},{\"x\":16,\"y\":2},{\"x\":18,\"y\":2},{\"x\":0,\"y\":1},{\"x\":18,\"y\":1},{\"x\":0,\"y\":0},{\"x\":2,\"y\":0},{\"x\":3,\"y\":0},{\"x\":4,\"y\":0},{\"x\":5,\"y\":0},{\"x\":6,\"y\":0},{\"x\":7,\"y\":0},{\"x\":8,\"y\":0},{\"x\":9,\"y\":0},{\"x\":10,\"y\":0},{\"x\":11,\"y\":0},{\"x\":12,\"y\":0},{\"x\":13,\"y\":0},{\"x\":14,\"y\":0},{\"x\":15,\"y\":0},{\"x\":16,\"y\":0},{\"x\":18,\"y\":0}]},\"you\":{\"id\":\"7ce0ba30-4734-4216-9be8-a421a73b40a6\",\"name\":\"local\",\"latency\":\"0\",\"health\":100,\"body\":[{\"x\":4,\"y\":7},{\"x\":4,\"y\":7},{\"x\":4,\"y\":7}],\"head\":{\"x\":4,\"y\":7},\"length\":3,\"shout\":\"\",\"squad\":\"\",\"customizations\":{\"color\":\"#002080\",\"head\":\"evil\",\"tail\":\"fat-rattle\"}}}")
	var state fastGame.GameState
	_ = json.Unmarshal(gameStr, &state)

	move(state, &newrelic.Transaction{})
}

func TestSnakePerformance4Snakes(t *testing.T) {
	t.Skip()

	cpufile, err := os.Create("cpu.pprof")
	if err != nil {
		panic(err)
	}
	err = pprof.StartCPUProfile(cpufile)
	if err != nil {
		panic(err)
	}
	defer cpufile.Close()
	defer pprof.StopCPUProfile()

	gameStr := []byte("{\"game\":{\"id\":\"cd0c9ca7-70fd-424e-a9c9-e47396c39ba8\",\"ruleset\":{\"name\":\"wrapped\",\"version\":\"cli\",\"settings\":{\"foodSpawnChance\":15,\"minimumFood\":1,\"hazardDamagePerTurn\":100,\"hazardMap\":\"\",\"hazardMapAuthor\":\"\",\"royale\":{\"shrinkEveryNTurns\":25},\"squad\":{\"allowBodyCollisions\":false,\"sharedElimination\":false,\"sharedHealth\":false,\"sharedLength\":false}}},\"map\":\"arcade_maze\",\"timeout\":500,\"source\":\"\"},\"turn\":0,\"board\":{\"height\":21,\"width\":19,\"snakes\":[{\"id\":\"2b8ac435-c5cf-476f-a175-58a42ced8d4b\",\"name\":\"tiam3\",\"latency\":\"0\",\"health\":100,\"body\":[{\"x\":4,\"y\":17},{\"x\":4,\"y\":17},{\"x\":4,\"y\":17}],\"head\":{\"x\":4,\"y\":17},\"length\":3,\"shout\":\"\",\"squad\":\"\",\"customizations\":{\"color\":\"#002080\",\"head\":\"evil\",\"tail\":\"fat-rattle\"}},{\"id\":\"965b1502-a81d-41d4-a891-fe6417f2101a\",\"name\":\"tiam2\",\"latency\":\"0\",\"health\":100,\"body\":[{\"x\":4,\"y\":7},{\"x\":4,\"y\":7},{\"x\":4,\"y\":7}],\"head\":{\"x\":4,\"y\":7},\"length\":3,\"shout\":\"\",\"squad\":\"\",\"customizations\":{\"color\":\"#002080\",\"head\":\"evil\",\"tail\":\"fat-rattle\"}},{\"id\":\"f08909e8-c6f8-4c9a-a5fb-322cfa08b134\",\"name\":\"tiam\",\"latency\":\"0\",\"health\":100,\"body\":[{\"x\":14,\"y\":7},{\"x\":14,\"y\":7},{\"x\":14,\"y\":7}],\"head\":{\"x\":14,\"y\":7},\"length\":3,\"shout\":\"\",\"squad\":\"\",\"customizations\":{\"color\":\"#002080\",\"head\":\"evil\",\"tail\":\"fat-rattle\"}},{\"id\":\"fa0e8904-4f4a-4895-bf88-b105e593500e\",\"name\":\"local\",\"latency\":\"0\",\"health\":100,\"body\":[{\"x\":14,\"y\":17},{\"x\":14,\"y\":17},{\"x\":14,\"y\":17}],\"head\":{\"x\":14,\"y\":17},\"length\":3,\"shout\":\"\",\"squad\":\"\",\"customizations\":{\"color\":\"#002080\",\"head\":\"evil\",\"tail\":\"fat-rattle\"}}],\"food\":[{\"x\":9,\"y\":11}],\"hazards\":[{\"x\":0,\"y\":20},{\"x\":2,\"y\":20},{\"x\":3,\"y\":20},{\"x\":4,\"y\":20},{\"x\":5,\"y\":20},{\"x\":6,\"y\":20},{\"x\":7,\"y\":20},{\"x\":8,\"y\":20},{\"x\":9,\"y\":20},{\"x\":10,\"y\":20},{\"x\":11,\"y\":20},{\"x\":12,\"y\":20},{\"x\":13,\"y\":20},{\"x\":14,\"y\":20},{\"x\":15,\"y\":20},{\"x\":16,\"y\":20},{\"x\":18,\"y\":20},{\"x\":0,\"y\":19},{\"x\":9,\"y\":19},{\"x\":18,\"y\":19},{\"x\":0,\"y\":18},{\"x\":2,\"y\":18},{\"x\":3,\"y\":18},{\"x\":5,\"y\":18},{\"x\":6,\"y\":18},{\"x\":7,\"y\":18},{\"x\":9,\"y\":18},{\"x\":11,\"y\":18},{\"x\":12,\"y\":18},{\"x\":13,\"y\":18},{\"x\":15,\"y\":18},{\"x\":16,\"y\":18},{\"x\":18,\"y\":18},{\"x\":0,\"y\":17},{\"x\":18,\"y\":17},{\"x\":0,\"y\":16},{\"x\":2,\"y\":16},{\"x\":3,\"y\":16},{\"x\":5,\"y\":16},{\"x\":7,\"y\":16},{\"x\":8,\"y\":16},{\"x\":9,\"y\":16},{\"x\":10,\"y\":16},{\"x\":11,\"y\":16},{\"x\":13,\"y\":16},{\"x\":15,\"y\":16},{\"x\":16,\"y\":16},{\"x\":18,\"y\":16},{\"x\":0,\"y\":15},{\"x\":5,\"y\":15},{\"x\":9,\"y\":15},{\"x\":13,\"y\":15},{\"x\":18,\"y\":15},{\"x\":0,\"y\":14},{\"x\":3,\"y\":14},{\"x\":5,\"y\":14},{\"x\":6,\"y\":14},{\"x\":7,\"y\":14},{\"x\":9,\"y\":14},{\"x\":11,\"y\":14},{\"x\":12,\"y\":14},{\"x\":13,\"y\":14},{\"x\":15,\"y\":14},{\"x\":18,\"y\":14},{\"x\":0,\"y\":13},{\"x\":3,\"y\":13},{\"x\":5,\"y\":13},{\"x\":13,\"y\":13},{\"x\":15,\"y\":13},{\"x\":18,\"y\":13},{\"x\":0,\"y\":12},{\"x\":1,\"y\":12},{\"x\":2,\"y\":12},{\"x\":3,\"y\":12},{\"x\":5,\"y\":12},{\"x\":7,\"y\":12},{\"x\":9,\"y\":12},{\"x\":11,\"y\":12},{\"x\":13,\"y\":12},{\"x\":15,\"y\":12},{\"x\":16,\"y\":12},{\"x\":17,\"y\":12},{\"x\":18,\"y\":12},{\"x\":7,\"y\":11},{\"x\":11,\"y\":11},{\"x\":0,\"y\":10},{\"x\":1,\"y\":10},{\"x\":2,\"y\":10},{\"x\":3,\"y\":10},{\"x\":5,\"y\":10},{\"x\":7,\"y\":10},{\"x\":9,\"y\":10},{\"x\":11,\"y\":10},{\"x\":13,\"y\":10},{\"x\":15,\"y\":10},{\"x\":16,\"y\":10},{\"x\":17,\"y\":10},{\"x\":18,\"y\":10},{\"x\":0,\"y\":9},{\"x\":3,\"y\":9},{\"x\":5,\"y\":9},{\"x\":13,\"y\":9},{\"x\":15,\"y\":9},{\"x\":18,\"y\":9},{\"x\":0,\"y\":8},{\"x\":3,\"y\":8},{\"x\":5,\"y\":8},{\"x\":7,\"y\":8},{\"x\":8,\"y\":8},{\"x\":9,\"y\":8},{\"x\":10,\"y\":8},{\"x\":11,\"y\":8},{\"x\":13,\"y\":8},{\"x\":15,\"y\":8},{\"x\":18,\"y\":8},{\"x\":0,\"y\":7},{\"x\":9,\"y\":7},{\"x\":18,\"y\":7},{\"x\":0,\"y\":6},{\"x\":2,\"y\":6},{\"x\":3,\"y\":6},{\"x\":5,\"y\":6},{\"x\":6,\"y\":6},{\"x\":7,\"y\":6},{\"x\":9,\"y\":6},{\"x\":11,\"y\":6},{\"x\":12,\"y\":6},{\"x\":13,\"y\":6},{\"x\":15,\"y\":6},{\"x\":16,\"y\":6},{\"x\":18,\"y\":6},{\"x\":0,\"y\":5},{\"x\":3,\"y\":5},{\"x\":15,\"y\":5},{\"x\":18,\"y\":5},{\"x\":0,\"y\":4},{\"x\":1,\"y\":4},{\"x\":3,\"y\":4},{\"x\":5,\"y\":4},{\"x\":7,\"y\":4},{\"x\":8,\"y\":4},{\"x\":9,\"y\":4},{\"x\":10,\"y\":4},{\"x\":11,\"y\":4},{\"x\":13,\"y\":4},{\"x\":15,\"y\":4},{\"x\":17,\"y\":4},{\"x\":18,\"y\":4},{\"x\":0,\"y\":3},{\"x\":5,\"y\":3},{\"x\":9,\"y\":3},{\"x\":13,\"y\":3},{\"x\":18,\"y\":3},{\"x\":0,\"y\":2},{\"x\":2,\"y\":2},{\"x\":3,\"y\":2},{\"x\":4,\"y\":2},{\"x\":5,\"y\":2},{\"x\":6,\"y\":2},{\"x\":7,\"y\":2},{\"x\":9,\"y\":2},{\"x\":11,\"y\":2},{\"x\":12,\"y\":2},{\"x\":13,\"y\":2},{\"x\":14,\"y\":2},{\"x\":15,\"y\":2},{\"x\":16,\"y\":2},{\"x\":18,\"y\":2},{\"x\":0,\"y\":1},{\"x\":18,\"y\":1},{\"x\":0,\"y\":0},{\"x\":2,\"y\":0},{\"x\":3,\"y\":0},{\"x\":4,\"y\":0},{\"x\":5,\"y\":0},{\"x\":6,\"y\":0},{\"x\":7,\"y\":0},{\"x\":8,\"y\":0},{\"x\":9,\"y\":0},{\"x\":10,\"y\":0},{\"x\":11,\"y\":0},{\"x\":12,\"y\":0},{\"x\":13,\"y\":0},{\"x\":14,\"y\":0},{\"x\":15,\"y\":0},{\"x\":16,\"y\":0},{\"x\":18,\"y\":0}]},\"you\":{\"id\":\"fa0e8904-4f4a-4895-bf88-b105e593500e\",\"name\":\"local\",\"latency\":\"0\",\"health\":100,\"body\":[{\"x\":14,\"y\":17},{\"x\":14,\"y\":17},{\"x\":14,\"y\":17}],\"head\":{\"x\":14,\"y\":17},\"length\":3,\"shout\":\"\",\"squad\":\"\",\"customizations\":{\"color\":\"#002080\",\"head\":\"evil\",\"tail\":\"fat-rattle\"}}}")
	var state fastGame.GameState
	_ = json.Unmarshal(gameStr, &state)

	move(state, &newrelic.Transaction{})
}

func TestSnakeStandardGame(t *testing.T) {
	// t.Skip()

	cpufile, err := os.Create("cpu.pprof")
	if err != nil {
		panic(err)
	}
	err = pprof.StartCPUProfile(cpufile)
	if err != nil {
		panic(err)
	}
	defer cpufile.Close()
	defer pprof.StopCPUProfile()
	gameStr := []byte("{\"game\":{\"id\":\"a8732cf3-42b6-4012-bbb5-d1cc4e03f397\",\"ruleset\":{\"name\":\"standard\",\"version\":\"cli\",\"settings\":{\"foodSpawnChance\":15,\"minimumFood\":1,\"hazardDamagePerTurn\":14,\"hazardMap\":\"\",\"hazardMapAuthor\":\"\",\"royale\":{\"shrinkEveryNTurns\":25},\"squad\":{\"allowBodyCollisions\":false,\"sharedElimination\":false,\"sharedHealth\":false,\"sharedLength\":false}}},\"map\":\"standard\",\"timeout\":500,\"source\":\"\"},\"turn\":2,\"board\":{\"height\":11,\"width\":11,\"snakes\":[{\"id\":\"45f8bf5b-02ea-4ccc-99f9-3079f5bbb805\",\"name\":\"tiam\",\"latency\":\"0\",\"health\":100,\"body\":[{\"x\":8,\"y\":10},{\"x\":8,\"y\":9},{\"x\":9,\"y\":9},{\"x\":9,\"y\":9}],\"head\":{\"x\":8,\"y\":10},\"length\":4,\"shout\":\"\",\"squad\":\"\",\"customizations\":{\"color\":\"#002080\",\"head\":\"evil\",\"tail\":\"fat-rattle\"}},{\"id\":\"2bd13899-e75e-4d8f-b6fb-fad018d04b7f\",\"name\":\"local\",\"latency\":\"0\",\"health\":98,\"body\":[{\"x\":10,\"y\":0},{\"x\":10,\"y\":1},{\"x\":9,\"y\":1}],\"head\":{\"x\":10,\"y\":0},\"length\":3,\"shout\":\"\",\"squad\":\"\",\"customizations\":{\"color\":\"#002080\",\"head\":\"evil\",\"tail\":\"fat-rattle\"}}],\"food\":[{\"x\":8,\"y\":0},{\"x\":5,\"y\":5},{\"x\":1,\"y\":2}],\"hazards\":[]},\"you\":{\"id\":\"2bd13899-e75e-4d8f-b6fb-fad018d04b7f\",\"name\":\"local\",\"latency\":\"0\",\"health\":98,\"body\":[{\"x\":10,\"y\":0},{\"x\":10,\"y\":1},{\"x\":9,\"y\":1}],\"head\":{\"x\":10,\"y\":0},\"length\":3,\"shout\":\"\",\"squad\":\"\",\"customizations\":{\"color\":\"#002080\",\"head\":\"evil\",\"tail\":\"fat-rattle\"}}}")
	var state fastGame.GameState
	_ = json.Unmarshal(gameStr, &state)

	move(state, &newrelic.Transaction{})
}
